<html>
	<head>
		<title>File Cabinet</title>
		<link rel="stylesheet" type="text/css" href="jquery-ui-1.flick.css"/>
		<link rel="stylesheet" type="text/css" href="jquery.tagit.css"/>
		<link rel="stylesheet" type="text/css" href="style/main.css"/>
		<style type="text/css">
#properties {
	width: 400px;
	display: inline-block;
	vertical-align: top;
}
#thumbnail {
	width: 400px;
	display: inline-block;
}
#full-image-viewport {
	height: 400px;
	width: 400px;
	overflow: hidden;
	border: solid thin black;
}
#full-image {
	position: relative;
	cursor: move;
}
		</style>
	</head>
	<body>
		<div style="float: right">
			<a href="index.html">All docs</a> |
			<a href="unseen.html">Unseen</a>
		</div>
		<div id="properties">
			<div>
				<span class="key">Filename</span>
				<span id="filename" class="value"></span>
			</div>
			<div>
				<span class="key">Uploaded</span>
				<span id="uploaded" class="value"></span>
			</div>
			<div>
				<span class="key">Effective</span>
				<span class="value"><input type="text" id="effective-date" size="20"/></span>
			</div>
			<div>
				<span class="key">Tags</span>
				<span class="value"><input name="tags" id="tags" style="position:relative" value=""/></span>
			</div>
			<div>
				<span class="key">Seen</span>
				<span class="value"><button onclick="doc.unseen = true; save();">Mark unseen</button></span>
			</div>
			<div>
				<span class="key">Original</span>
				<span class="value"><a id="download" href="" target="_blank">Download</a></span>
			</div>
		</div>
		<div id="thumbnail">
			<div id="thumb-select" style="display: none">
				Current: <input type="text" disabled="true" id="thumb-current"/>
			</div>
			<div id="full-image-viewport">
				<img id="full-image" src=""/>
			</div>
		</div>
		<script type="text/javascript">
var tags = [];
var doc = null;

var bootstrap = function() {
	db.view("ui/tags", {
		group: true,
		success: function(data) {
			tags = [];
			for (var i = 0; i < data.rows.length; i++) {
				if (data.rows[i].key && data.rows[i].key.trim().length > 0) {
					tags.push(data.rows[i].key.trim());
				}
			}
		}
	});

	var docId = window.location.hash.substr(1);
	db.openDoc(docId, {
		success:function(data){
			doc = data;
			showDoc();
		},
		error: function(d1, d2, d3) {
			console.log('Failed to load', d1, d2, d3);
			alert("Failed to load");
		}
	});
};

var showDoc = function() {
	doc.unseen = false;
	$('#filename').html(doc.filename);
	$('#uploaded').html(dateArrayToString(doc.uploaded));
	
	var effectiveDate = $('#effective-date');
	var effectiveDateString = dateArrayToString(dateObjectToArray(new Date()));
	if (doc.effective) {
		effectiveDateString = dateArrayToString(doc.effective);
	}
	effectiveDate.val(effectiveDateString);
	effectiveDate.datepicker({
		dateFormat: "yy-mm-dd"
	});
	effectiveDate.change(function(){
		doc.effective = dateStringToArray(effectiveDate.val());
		save();
	});
	
	$('#download').attr('href', db.uri + doc._id + '/raw');
	
	var tagsInput = $('#tags');
	tagsInput.val(doc.tags.join(','));
	tagsInput.tagit({
		autocomplete: {
			source: function(request, callback) {
				var suggestions = [];
				for (var i = 0; i < tags.length; i++) {
					if (tags[i].indexOf(request.term) != -1) {
						suggestions.push(tags[i]);
					}
				}
				callback(suggestions);
			}
		}
	});
	tagsInput.change(function(){
		doc.tags = tagsInput.val().split(',');
		save();
	});
	
	if (docHelper.hasThumbnail(doc)) {
		showThumb(doc.thumbnail);
	} else if (docHelper.isThumbnailDisabled(doc)) {
		$('#thumbnail').hide();
	} else {
		var thumbNames = getThumbNames();
		if (thumbNames.length == 0) {
			$('#thumbnail').hide();
		} else {
			var thumbBar = $('#thumb-select');
			
			$('<button>Select current</button>').click(function(){
				var current = $('#thumb-current').val();
				for (var i = 0; i < thumbNames.length; i++) {
					if (thumbNames[i] != current) {
						delete doc._attachments[thumbNames[i]];
					}
				}
				doc.thumbnail = current;
				save();
				thumbBar.hide();
			}).appendTo(thumbBar);
			
			$('<button>Disable thumbs</button>').click(function(){
				doc.thumbnail = false;
				save();
				$('#thumbnail').hide();
			}).appendTo(thumbBar);
			
			$('<br/>').appendTo(thumbBar);
			
			for (var i = 0; i < thumbNames.length; i++) {
				var onClick = function(name){
					return function() { showThumb(name); };
				}(thumbNames[i]);
				$('<button>'+thumbNames[i]+'</button>').click(onClick).appendTo(thumbBar);
			}
			showThumb(thumbNames[0]);
			
			thumbBar.show();
		}
	}
};

var getThumbNames = function() {
	var result = [];
	for (var key in doc._attachments) {
		if (key.substr(0,5) == "thumb") {
			result.push(key);
		}
	}
	return result;
};

var showThumb = function(thumbName) {
	$('#thumb-current').val(thumbName);
	var display = $('#full-image');
	display.attr('src', db.uri + doc._id + '/' + thumbName);
	display.draggable({
		drag: function(event, ui) {
			if(ui.position.top>0) { ui.position.top = 0; }
			var maxtop = ui.helper.parent().height()-ui.helper.height();
			if(ui.position.top<maxtop) { ui.position.top = maxtop; }
			if(ui.position.left>0) { ui.position.left = 0; }
			var maxleft = ui.helper.parent().width()-ui.helper.width();
			if(ui.position.left<maxleft) { ui.position.left = maxleft; }
		}
	});
};

var save = function() {
	doc.tags.sort();
	db.saveDoc(doc, {
		error: function(d1, d2, d3) {
			console.log('Failed to save', d1, d2, d3);
			alert("Failed to save");
		}
	});
};
</script>

	</body>

	<script src="/_utils/script/json2.js"></script>
	<script src="/_utils/script/sha1.js"></script>
	<script src="/_utils/script/base64.js"></script>
	<script src="/_utils/script/jquery.js"></script>
	<script src="/_utils/script/jquery.couch.js"></script>
	<script src="vendor/couchapp/md5.js"></script>
	<script src="vendor/couchapp/jquery.mustache.js"></script>
	<script src="jquery-ui-1.10.3.min.js"></script>
	<script src="tag-it.2.0.js"></script>
	<script src="script/doc-helper.js"></script>
	<script src="script/main.js"></script>
</html>