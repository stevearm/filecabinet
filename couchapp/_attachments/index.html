<html>
	<head>
		<title>File Cabinet</title><link rel="stylesheet" type="text/css" href="jquery-ui-1.flick.css"/>
		<link rel="stylesheet" type="text/css" href="jquery.tagit.css"/>
		<link rel="stylesheet" type="text/css" href="style/main.css"/>
		<style type="text/css">
		</style>
	</head>
	<body>
		<div style="float: right">
			<a href="unseen.html">Unseen</a>
		</div>
		<div id="tag-filter"></div>
		<div>
			<span id="tag-filter-all" class="tag selected">All</span>
			<span id="tag-filter-none" class="tag">None</span>
			<span id="tag-filter-from" class="tag">Effective from <input type="text" size="10"/></span>
			<span id="tag-filter-to" class="tag">Effective to <input type="text" size="10"/></span>
			<span id="tag-sort-order" class="tag">Newest first</span>
			<span id="archive-download-link" class="tag">
				Download files with pattern
				<input type="text" size="15" value="%y-%m-%d-%t.pdf">
			</span>
			<b>%y</b>ear,
			<b>%m</b>onth,
			<b>%d</b>ay,
			<b>%t</b>ags
		</div>
		<div id="files"></div>

		<script type="text/javascript">
var tags = {};
var dates = {
	from : null,
	fromEnabled : false,
	to : null,
	toEnabled : false,
	newestFirst : true
};

var bootstrap = function() {
	db.view("ui/tags", {
		group: true,
		success: function(data) {
			for (var i = 0; i < data.rows.length; i++) {
				if (data.rows[i].key && data.rows[i].key.trim().length > 0) {
					tags[data.rows[i].key.trim()] = false;
				}
			}
			redraw();
		}
	});
	
	$('#tag-filter-all').click(function() {
		for (var tag in tags) {
			tags[tag] = true;
		}
		redraw();
	});
	$('#tag-filter-none').click(function(){
		for (var tag in tags) {
			tags[tag] = false;
		}
		redraw();
	});

	// Date from
	var dateElement = $('#tag-filter-from');
	dateElement.click(function(element) {
		return function() {
			if ($(event.target).is("input")) { return; }
			if (dates.fromEnabled) {
				dates.fromEnabled = false;
				element.removeClass('selected');
			} else {
				dates.fromEnabled = true;
				element.addClass('selected');
			}
			redraw();
		};
	}(dateElement));
	dateElement = $('#tag-filter-from input');
	var date = new Date();
	date.setDate(date.getDate() - 30);
	dateElement.val(dateArrayToString(dateObjectToArray(date)));
	dateElement.datepicker({ dateFormat: "yy-mm-dd" });
	dateElement.change(function(){
		var element = $(this);
		dates.from = element.val();
		if (dates.fromEnabled && dates.toEnabled && dates.from > dates.to) {
			element.click();
		}
		redraw();
	});

	// Date to
	dateElement = $('#tag-filter-to');
	dateElement.click(function(element) {
		return function() {
			if ($(event.target).is("input")) { return; }
			if (dates.toEnabled) {
				dates.toEnabled = false;
				element.removeClass('selected');
			} else {
				dates.toEnabled = true;
				element.addClass('selected');
			}
			redraw();
		};
	}(dateElement));
	dateElement = $('#tag-filter-to > input');
	dateElement.val(dateArrayToString(dateObjectToArray(date)));
	dateElement.datepicker({ dateFormat: "yy-mm-dd" });
	dateElement.change(function(){
		var element = $(this);
		dates.to = element.val();
		if (dates.fromEnabled && dates.toEnabled && dates.from > dates.to) {
			element.click();
		}
		redraw();
	});

	// Sort
	dateElement = $('#tag-sort-order');
	dateElement.click(function(element) {
		return function() {
			if (dates.newestFirst) {
				dates.newestFirst = false;
				element.html('Oldest first');
			} else {
				dates.newestFirst = true;
				element.html('Newest first');
			}
			redraw();
		};
	}(dateElement));

	// Download
	$('#archive-download-link').click(function() {
		alert("Not yet implemented");
	});
};

var fixUpSparseDoc = function(doc) {
	if (!('effective' in doc)) {
		doc.effective = extractDateArray(renderDate(new Date()));
	}
	if (!('tags' in doc)) {
		doc.tags = [];
	}
};

var renderDoc = function(doc) {
	var render = {
		clickListener : function(doc){
			return function(event) {
				if (!$(event.target).is("a")) {
					document.location.href = "document.html#" + doc._id;
				}
			}
		}(doc),
		html : ""
	};
	render.html = '<div class="doc">';
	render.html +=  '<div class="thumb">';
	render.html +=  docHelper.hasThumbnail(doc) ? '<img src="../../'+doc._id+'/'+doc.thumbnail+'"/>' : 'No thumb';
	render.html +=    '<br><a href="../../'+doc._id+'/raw" target="_blank">Download</a>';
	render.html +=  '</div>';
	render.html +=  '<div class="filename"><span class="key">Filename</span><span class="value">'+doc.filename+'</span></div>';
	render.html +=  '<div><span class="key">Uploaded</span><span class="value">'+dateArrayToString(doc.uploaded)+'</span></div>';
	render.html +=  '<div><span class="key">Effective</span><span class="value">'+dateArrayToString(doc.effective)+'</span></div>';
	render.html +=  '<ul>';

	for (var i = 0; i < doc.tags.length; i++) {
		render.html += '<li>'+doc.tags[i]+'</li>';
	}
	render.html += '</ul>';
	render.html += '</div>';

	return render;
};

var redraw = function() {
	var tagFilter = $('#tag-filter');
	tagFilter.empty();
	var tagNames = Object.keys(tags);
	tagNames.sort();
	for (var i = 0; i < tagNames.length; i++) {
		var element = $('<span class="tag'+( (tags[tagNames[i]]) ? ' selected' : '' )+'">'+tagNames[i]+'</span>');
		element.click(function(event) {
			var tmp = $(this);
			var tagName = tmp.html();
			if (tmp.hasClass('selected')) {
				tmp.removeClass('selected');
				tags[tagName] = false;
			} else {
				tmp.addClass('selected');
				tags[tagName] = true;
			}
			redraw();
		});
		tagFilter.append(element);
	}
	
	// Create tag list
	var tagList = [];
	for (var tag in tags) {
		if (tags[tag]) {
			tagList.push(tag);
		}
	}
	if (tagList.length == 0) {
		tagList = [ null ];
	}
	
	// Filter docs for display
	$.ajax({
		type:"POST",
		url:"_view/tags?reduce=false&include_docs=true",
		data: JSON.stringify({ keys: tagList }),
		contentType: "application/json; charset=utf-8",
		success:function(json){
			var docsToDisplay = {};
			for (var i = 0; i < json.rows.length; i++) {
				var doc = json.rows[i].doc;
				fixUpSparseDoc(doc);
				docsToDisplay[json.rows[i].id] = doc;
			}
			showNormalDocs(docsToDisplay);
		},
		error : genericAjaxError,
		dataType:"json"
	});
};

var showNormalDocs = function(docs) {
	var allFiles = [];
	for (var id in docs) {
		var doc = docs[id];

		// Filter by date
		if (dates.fromEnabled && renderDateArray(doc.effective) < dates.from) {
			continue;
		}
		if (dates.toEnabled && dates.to < renderDateArray(doc.effective)) {
			continue;
		}
		if (doc.unseen) {
			continue;
		}
		allFiles.push(doc);
	}

	// Sort allFiles and newFiles
	var comparator = function(a,b) {
		if (a.effective < b.effective) return dates.newestFirst ? 1 : -1;
		if (a.effective > b.effective) return dates.newestFirst ? -1 : 1;
		return 0;
	};
	allFiles.sort(comparator);

	// Render all files
	var allFilesNode = $('#files');
	allFilesNode.empty();
	for (var i = 0; i < allFiles.length; i++) {
		var doc = allFiles[i];
		allFilesNode.append(renderDoc(doc));
	}
};

var genericAjaxError = function(req, response) {
	alert("Error contacting server");
	console.log("Failed request " + response, req);
};
		</script>


	<script src="/_utils/script/json2.js"></script>
	<script src="/_utils/script/sha1.js"></script>
	<script src="/_utils/script/base64.js"></script>
	<script src="/_utils/script/jquery.js"></script>
	<script src="/_utils/script/jquery.couch.js"></script>
	<script src="vendor/couchapp/md5.js"></script>
	<script src="vendor/couchapp/jquery.mustache.js"></script>
	<script src="jquery-ui-1.10.3.min.js"></script>
	<script src="tag-it.2.0.js"></script>
	<script src="script/main.js"></script>
	</body>
</html>